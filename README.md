#at haproxy directory for AFL++
export AFL_USE_ASAN=1
sed -i 's/int main(/int main1(/' src/haproxy.c
CC="afl-clang-fast" make -e TARGET=linux-glibc USE_SYSTEMD=1 V=1          DESTDIR=debian/haproxy          PREFIX=/usr          IGNOREGIT=true   
       MANDIR=/usr/share/man          DOCDIR=/usr/share/doc/haproxy          USE_PCRE2=1          USE_PCRE2_JIT=1          USE_OPENSSL=1          USE_SLZ=1          USE_LUA=1          USE_PROMEX=1          USE_OT=1          LUA_INC=/usr/include/lua5.3          EXTRA=admin/halog/halog  ADDLIB="-latomic"
# Copy expN.c to here and compile like (need replace exp1 and exp1.c on needed experiment). 
afl-clang-fast -DCONFIG_HAPROXY_VERSION=\"3.2.0\" -DCONFIG_HAPROXY_DATE=\"2023/12/13\" -Iinclude -o exp1 exp1.c src/slz.o src/ev_poll.o src/ev_epoll.o src/cpuset.o src/ssl_sample.o src/ssl_sock.o src/ssl_crtlist.o src/ssl_ckch.o src/ssl_utils.o src/cfgparse-ssl.o src/jwt.o src/hlua.o src/hlua_fcn.o addons/promex/service-prometheus.o src/namespace.o addons/ot/src/cli.o addons/ot/src/conf.o addons/ot/src/event.o addons/ot/src/filter.o addons/ot/src/group.o addons/ot/src/http.o addons/ot/src/opentracing.o addons/ot/src/parser.o addons/ot/src/pool.o addons/ot/src/scope.o addons/ot/src/util.o src/mux_h2.o src/mux_fcgi.o src/mux_h1.o src/tcpcheck.o src/stream.o src/stats.o src/http_ana.o src/server.o src/stick_table.o src/sample.o src/flt_spoe.o src/tools.o src/log.o src/cfgparse.o src/peers.o src/backend.o src/resolvers.o src/cli.o src/connection.o src/proxy.o src/http_htx.o src/cfgparse-listen.o src/pattern.o src/check.o src/haproxy.o src/cache.o src/stconn.o src/http_act.o src/http_fetch.o src/http_client.o src/listener.o src/dns.o src/vars.o src/debug.o src/tcp_rules.o src/sink.o src/h1_htx.o src/task.o src/mjson.o src/h2.o src/filters.o src/server_state.o src/payload.o src/fcgi-app.o src/map.o src/htx.o src/h1.o src/pool.o src/cfgparse-global.o src/trace.o src/tcp_sample.o src/flt_http_comp.o src/mux_pt.o src/flt_trace.o src/mqtt.o src/acl.o src/sock.o src/mworker.o src/tcp_act.o src/ring.o src/session.o src/proto_tcp.o src/fd.o src/channel.o src/activity.o src/queue.o src/lb_fas.o src/http_rules.o src/extcheck.o src/thread.o src/http.o src/lb_chash.o src/applet.o src/compression.o src/raw_sock.o src/ncbuf.o src/frontend.o src/errors.o src/uri_normalizer.o src/http_conv.o src/lb_fwrr.o src/sha1.o src/proto_sockpair.o src/mailers.o src/lb_fwlc.o src/ebmbtree.o src/cfgcond.o src/action.o src/xprt_handshake.o src/protocol.o src/proto_uxst.o src/proto_udp.o src/lb_map.o src/fix.o src/ev_select.o src/arg.o src/sock_inet.o src/mworker-prog.o src/hpack-dec.o src/cfgparse-tcp.o src/sock_unix.o src/shctx.o src/proto_uxdg.o src/fcgi.o src/eb64tree.o src/clock.o src/chunk.o src/cfgdiag.o src/signal.o src/regex.o src/lru.o src/eb32tree.o src/eb32sctree.o src/cfgparse-unix.o src/hpack-tbl.o src/ebsttree.o src/ebimtree.o src/base64.o src/auth.o src/uri_auth.o src/time.o src/ebistree.o src/dynbuf.o src/wdt.o src/pipe.o src/init.o src/http_acl.o src/hpack-huff.o src/hpack-enc.o src/dict.o src/freq_ctr.o src/ebtree.o src/hash.o src/dgram.o src/version.o  -lparsec-base -lparsec-mac -lparsec-cap -lcrypt -ldl -lrt -lpthread -Wl,--export-dynamic  -lssl -lcrypto -ldl -Wl,--export-dynamic  -llua5.3 -lm -ldl -lsystemd -L/usr/lib -L/usr/lib -lpcre2-8 -lpcre2-posix -lopentracing-c-wrapper  -latomic

#at haproxy directory for libFuzzer
sed -i 's/int main(/int main1(/' src/haproxy.c

CC="clang-19" CFLAGS="-fuzzer-no-link" make -e TARGET=linux-glibc USE_SYSTEMD=1 V=1          DESTDIR=debian/haproxy          PREFIX=/usr          IGNOREGIT=true   
       MANDIR=/usr/share/man          DOCDIR=/usr/share/doc/haproxy          USE_PCRE2=1          USE_PCRE2_JIT=1          USE_OPENSSL=1          USE_SLZ=1          USE_LUA=1          USE_PROMEX=1          USE_OT=1          LUA_INC=/usr/include/lua5.3          EXTRA=admin/halog/halog  ADDLIB="-latomic"
# Copy expN.c to here and compile like (need replace exp1 and exp1.c on needed experiment). 
clang-19 -fsanitize=address,fuzzer -DCONFIG_HAPROXY_VERSION=\"3.2.0\" -DCONFIG_HAPROXY_DATE=\"2023/12/13\" -Iinclude -o exp1 exp1.c src/slz.o src/ev_poll.o src/ev_epoll.o src/cpuset.o src/ssl_sample.o src/ssl_sock.o src/ssl_crtlist.o src/ssl_ckch.o src/ssl_utils.o src/cfgparse-ssl.o src/jwt.o src/hlua.o src/hlua_fcn.o addons/promex/service-prometheus.o src/namespace.o addons/ot/src/cli.o addons/ot/src/conf.o addons/ot/src/event.o addons/ot/src/filter.o addons/ot/src/group.o addons/ot/src/http.o addons/ot/src/opentracing.o addons/ot/src/parser.o addons/ot/src/pool.o addons/ot/src/scope.o addons/ot/src/util.o src/mux_h2.o src/mux_fcgi.o src/mux_h1.o src/tcpcheck.o src/stream.o src/stats.o src/http_ana.o src/server.o src/stick_table.o src/sample.o src/flt_spoe.o src/tools.o src/log.o src/cfgparse.o src/peers.o src/backend.o src/resolvers.o src/cli.o src/connection.o src/proxy.o src/http_htx.o src/cfgparse-listen.o src/pattern.o src/check.o src/haproxy.o src/cache.o src/stconn.o src/http_act.o src/http_fetch.o src/http_client.o src/listener.o src/dns.o src/vars.o src/debug.o src/tcp_rules.o src/sink.o src/h1_htx.o src/task.o src/mjson.o src/h2.o src/filters.o src/server_state.o src/payload.o src/fcgi-app.o src/map.o src/htx.o src/h1.o src/pool.o src/cfgparse-global.o src/trace.o src/tcp_sample.o src/flt_http_comp.o src/mux_pt.o src/flt_trace.o src/mqtt.o src/acl.o src/sock.o src/mworker.o src/tcp_act.o src/ring.o src/session.o src/proto_tcp.o src/fd.o src/channel.o src/activity.o src/queue.o src/lb_fas.o src/http_rules.o src/extcheck.o src/thread.o src/http.o src/lb_chash.o src/applet.o src/compression.o src/raw_sock.o src/ncbuf.o src/frontend.o src/errors.o src/uri_normalizer.o src/http_conv.o src/lb_fwrr.o src/sha1.o src/proto_sockpair.o src/mailers.o src/lb_fwlc.o src/ebmbtree.o src/cfgcond.o src/action.o src/xprt_handshake.o src/protocol.o src/proto_uxst.o src/proto_udp.o src/lb_map.o src/fix.o src/ev_select.o src/arg.o src/sock_inet.o src/mworker-prog.o src/hpack-dec.o src/cfgparse-tcp.o src/sock_unix.o src/shctx.o src/proto_uxdg.o src/fcgi.o src/eb64tree.o src/clock.o src/chunk.o src/cfgdiag.o src/signal.o src/regex.o src/lru.o src/eb32tree.o src/eb32sctree.o src/cfgparse-unix.o src/hpack-tbl.o src/ebsttree.o src/ebimtree.o src/base64.o src/auth.o src/uri_auth.o src/time.o src/ebistree.o src/dynbuf.o src/wdt.o src/pipe.o src/init.o src/http_acl.o src/hpack-huff.o src/hpack-enc.o src/dict.o src/freq_ctr.o src/ebtree.o src/hash.o src/dgram.o src/version.o  -lparsec-base -lparsec-mac -lparsec-cap -lcrypt -ldl -lrt -lpthread -Wl,--export-dynamic  -lssl -lcrypto -ldl -Wl,--export-dynamic  -llua5.3 -lm -ldl -lsystemd -L/usr/lib -L/usr/lib -lpcre2-8 -lpcre2-posix -lopentracing-c-wrapper  -latomic
